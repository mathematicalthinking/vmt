const mongoose = require('mongoose');

const { ObjectId } = mongoose.Schema.Types;
const Room = require('./Room.js');

const Message = new mongoose.Schema({
  user: { type: ObjectId, ref: 'User' },
  text: { type: String },
  room: { type: ObjectId, ref: 'Room', required: true },
  autogenerated: { type: Boolean },
  timestamp: { type: Number }, // SAVING THIS IN UNIX TIME FOR EASY SORTING but in MS
  reference: {
    element: { type: String },
    elementType: { type: String },
    tab: { type: ObjectId, ref: 'Tab' },
    wasObjectDeleted: { type: Boolean }, // so we know not to update deleted references when objects are renamed
    wasObjectUpdated: { type: Boolean }, // e.g. renamed, moved, redefined
    pathParameter: { type: Number },
    isForRegion: { type: Boolean },
    x: { type: Number },
    y: { type: Number },
    z: { type: Number },
    description: { type: String },
    viewNum: { type: Number },
  },
  messageType: {
    type: String,
    enum: [
      'TEXT',
      'TOOK_CONTROL',
      'RELEASED_CONTROL',
      'LEFT_ROOM',
      'SWITCH_TAB',
      'NEW_TAB',
      'JOINED_ROOM',
      'RESET_ROOM',
    ],
    default: 'TEXT',
  },
  tab: { type: ObjectId, ref: 'Tab' },
  color: { type: String, default: '#333' },
  description: { type: String }, // used to describe references
  isTrashed: { type: Boolean, default: false },
});

// Add this message to the room's chat
Message.pre('save', async function() {
  if (this.isNew) {
    this.timestamp = Date.now();
    // @TODO CHANGIN controlledBY HERE IS TERRRRIBLLE!!!!! THIS SHOULD ALL BE DONE SOMEWHERE ELSE WHERE ITS LESS OF A SIDE EFFECT
    if (this.messageType === 'TOOK_CONTROL') {
      try {
        await Room.findByIdAndUpdate(this.room, {
          controlledBy: this.user._id,
          $addToSet: { chat: this._id },
        });
      } catch (err) {
        console.log('ERROR: ', err);
      }
    } else if (
      ['LEFT_ROOM', 'JOINED_ROOM', 'SWITCH_TAB', 'RESET_ROOM'].includes(
        this.messageType
      )
    ) {
      try {
        await Room.findByIdAndUpdate(
          this.room,
          {
            $addToSet: { chat: this._id },
          },
          { timestamps: false } // Don't update the room's updateAt if we just peek at it
        );
      } catch (err) {
        console.log(err);
      }
    } else {
      try {
        await Room.findByIdAndUpdate(this.room, {
          $addToSet: { chat: this._id },
        });
      } catch (err) {
        console.log(err);
      }
    }
  }
});
module.exports = mongoose.model('Message', Message);
